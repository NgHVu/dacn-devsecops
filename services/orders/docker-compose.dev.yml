version: "3.9"

# Định nghĩa một mạng riêng cho service này
networks:
  dacn-net:
    external: true

volumes:
  orders-pg-data: # Đặt tên volume riêng cho orders-service

services:
  # 1. Service cho CSDL PostgreSQL của orders
  orders-db:
    image: postgres:15-alpine
    container_name: orders-db
    networks:
      - dacn-net
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: orders_db 
    ports:
      - "5434:5432" 
    volumes:
      - orders-pg-data:/var/lib/postgresql/data
    restart: unless-stopped
    # Healthcheck để kiểm tra xem CSDL đã sẵn sàng chưa
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d orders_db"] 
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Service cho ứng dụng Spring Boot orders
  orders-app:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: orders-app
    networks:
      - dacn-net
    ports:
      - "8083:8083" 
    environment:
      # Ghi đè cấu hình CSDL để trỏ vào tên service "orders-db"
      DB_URL: jdbc:postgresql://orders-db:5432/orders_db 
      DB_USER: admin
      DB_PASSWORD: admin
      JPA_DDL_AUTO: update
      JWT_SECRET_KEY: dGhpcy1pcy1hLXNlY3JldC1rZXktZm9yLWp3dC1hdXRoZW50aWNhdGlvbi1pbi1kZXZzZWNvcHMtcHJvamVjdC1tdXN0LWJlLXZlcnktbG9uZy1hbmQtc2VjdXJl
      JWT_EXPIRATION_MS: 86400000
      SPRING_PROFILES_ACTIVE: local
    depends_on:
      orders-db:
        condition: service_healthy # Chỉ khởi động app khi CSDL "khỏe mạnh"
    restart: on-failure
